<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Custom Inverse Kinematics MoveIt Plugin | Ashith Shyam Babu, PhD </title> <meta name="author" content="Ashith Shyam Babu, PhD"> <meta name="description" content="How to make a Inverse Kinematics Plugin Compatable with MoveIt"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%94%A5&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ashbabu.github.io/blog/2022/Custom_Inverse_Kinematics_MoveIt_Plugin/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Ashith</span> Shyam Babu, PhD </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">blog </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/blog/category/robotics/">Robotics</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/category/programming/">Programming</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/category/computer-vision/">Computer Vision</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/category/reinforcement-learning/">Reinforcement Learning</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/category/machine-learning/">Machine Learning</a> </div> </li> <li class="nav-item "> <a class="nav-link" href="/contact/">contact </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Custom Inverse Kinematics MoveIt Plugin</h1> <p class="post-meta"> June 16, 2022 </p> <p class="post-tags"> <a href="/blog/2022"> <i class="fa-solid fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/category/robotics"> <i class="fa-solid fa-tag fa-sm"></i> Robotics</a>   <a href="/blog/category/programming"> <i class="fa-solid fa-tag fa-sm"></i> Programming</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h3 id="introduction">Introduction</h3> <p>Solving inverse kinematics (IK) is a fundamental problem in robotics that converts task space co-ordinates to joint space variables. To solve for joint space values (<code class="language-plaintext highlighter-rouge">q's</code>) analytically, we require non-linear transcendental equations connecting the task-space and joint-space values or forward kinematic equations (Note that IK can be seen as a minimization problem as well). As a simple case to understand this, lets take the case of a single degree of freedom planar robot arm having a revolute joint. We can write the forward kinematics as \begin{align} x = l * \cos(q) \nonumber \newline y = l * \sin(q) \nonumber \end{align} where <code class="language-plaintext highlighter-rouge">l</code> and <code class="language-plaintext highlighter-rouge">q</code> are respectively the link length and the angle that the link makes with the fixed co-ordinate system. The inverse kinematics (given (x,y), what is the value of <code class="language-plaintext highlighter-rouge">q</code>?) can be written as</p> <p>\begin{align} \tan (q) = \frac{y}{x} \implies q = \arctan(\frac{y}{x}) \label{eqn:pend_ik} \end{align}</p> <p>Equation \ref{eqn:pend_ik} is a very simple example of an analytic inverse kinematics solution. <a href="http://openrave.org/docs/0.8.2/openravepy/ikfast/" rel="external nofollow noopener" target="_blank">IKFast</a> is one such analytic IK solver for robot arms having any number of joints and is quite popular. However, it’s often difficult to set it up and there are a lot of “IKFast Not Working” queries if you do a google search.</p> <p>In <a href="https://www.ros.org/" rel="external nofollow noopener" target="_blank">ROS</a>, the most popular way of setting up a robot is using <a href="http://wiki.ros.org/urdf/Tutorials" rel="external nofollow noopener" target="_blank">URDF</a> and I will discuss another simple case of generating symbolic forward kinematics equations using <a href="https://www.sympy.org/en/index.html" rel="external nofollow noopener" target="_blank">sympy</a> in <a href="/blog/2022/Generating_Symbolic_Expression_for_Forward_Kinematics/">another post</a>. For now, I will assume that we already have an analytic expression for the IK.</p> <p>This article will discuss the various steps involved in creating a custom IK plugin to be used along with <a href="https://moveit.ros.org/" rel="external nofollow noopener" target="_blank">MoveIt</a>. (Why MoveIt because it is a very powerful and popular open source library for motion planning problems and is used by several robots). Firstly, we need to create a plugin using <a href="http://wiki.ros.org/pluginlib" rel="external nofollow noopener" target="_blank">pluginlib</a>, <a href="http://wiki.ros.org/pluginlib/Tutorials/Writing%20and%20Using%20a%20Simple%20Plugin" rel="external nofollow noopener" target="_blank">pluginlib_tutorials</a>. The KDL and SRV kinematics plugin <a href="https://moveit.ros.org/documentation/plugins/#kinematicsbase" rel="external nofollow noopener" target="_blank">documentation</a> give a very good idea of how to get started and set it up. I am just writing my experiences here for a quick overview of various things involved. So the steps involved are as follows</p> <ul> <li>Open a terminal and <code class="language-plaintext highlighter-rouge">cd</code> to <code class="language-plaintext highlighter-rouge">catkin_ws/src</code> and <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>catkin_create_pkg moveit_kinematics_plugin roscpp rospy pluginlib moveit_core
</code></pre></div> </div> </li> <li> <code class="language-plaintext highlighter-rouge">cd moveit_kinematics_plugin/include/moveit_kinematics_plugin</code> and create a <code class="language-plaintext highlighter-rouge">TestKinematicsPlugin.h</code>(<a href="https://github.com/ashBabu/moveit_kinematics_plugin/blob/master/include/moveit_kinematics_plugin/TestKinematicsPlugin.h" rel="external nofollow noopener" target="_blank">here</a>).</li> <li>Most importatnly, this header file should inherit the <code class="language-plaintext highlighter-rouge">kinematics::KinematicsBase</code> and implement the pure virtual methods <code class="language-plaintext highlighter-rouge">getPositionFK()</code>, <code class="language-plaintext highlighter-rouge">getJointNames()</code>, <code class="language-plaintext highlighter-rouge">getLinkNames()</code>, the overloaded <code class="language-plaintext highlighter-rouge">getPositionIK()</code> and the <code class="language-plaintext highlighter-rouge">searchPositionIk()</code>. This also should have the <code class="language-plaintext highlighter-rouge">initialize()</code> method for initialization using the new syntax which takes the <code class="language-plaintext highlighter-rouge">robot_model</code> as the first argument instead of the deprecated <code class="language-plaintext highlighter-rouge">robot_description</code>.</li> <li>I have added three other private functions, <code class="language-plaintext highlighter-rouge">getIKSolutions()</code>, <code class="language-plaintext highlighter-rouge">isSolutionValid()</code> and <code class="language-plaintext highlighter-rouge">getNearestSolutionToSeed()</code> for my specific case.</li> <li> <a href="https://github.com/ashBabu/moveit_kinematics_plugin/blob/master/src/TestKinematicsPlugin.cpp#L188" rel="external nofollow noopener" target="_blank">getIKSolutions()</a> implements the solution (for example equation \ref{eqn:pend_ik}). Something <strong>Important</strong> that I found here is that if you have two joint variables <code class="language-plaintext highlighter-rouge">q1</code> and <code class="language-plaintext highlighter-rouge">q2</code> which respectively being the first and second joints, the <code class="language-plaintext highlighter-rouge">solutions</code> vector should implement something like <code class="language-plaintext highlighter-rouge">solutions.push_back({q2, q1})</code>. (Something to be investigated again)</li> <li> <code class="language-plaintext highlighter-rouge">isSolutionValid()</code> checks if the solution found is within the joint limits and <code class="language-plaintext highlighter-rouge">getNearestSolutionToSeed()</code> finds the solution that is closest to the seed state provided. This is implemented for my specific robot and may not be required in general.</li> <li>The last but very important bit is the implementation of one of the overloaded <code class="language-plaintext highlighter-rouge">searchPositionIK()</code> method. I have numbered it as 4. Go through it and copy paste the function as such</li> <li>The <code class="language-plaintext highlighter-rouge">solution_callback()</code> is provided to check if the configuration of the robot arm corresponding to the solution is collision free or not. This should be implemented for additional safety but the program would work even without this.</li> <li>Add the following as well in the <code class="language-plaintext highlighter-rouge">TestKinematicsPlugin.cpp</code> <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>#include &lt;class_loader/class_loader.hpp&gt;
CLASS_LOADER_REGISTER_CLASS(moveit_kinematics_plugin::TestKinematicsPlugin, kinematics::KinematicsBase);
</code></pre></div> </div> </li> <li>Create a <code class="language-plaintext highlighter-rouge">plugin_description.xml</code> file in the same level as <code class="language-plaintext highlighter-rouge">src</code> that should look like</li> </ul> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;library path="lib/test_arm_moveit_plugin"&gt;
  &lt;class base_class_type="kinematics::KinematicsBase" name="analytic/kinematicsPlugin" type="moveit_kinematics_plugin::TestArmKinematicsPlugin"&gt;
    &lt;description&gt;MoveIt plugin for solving the kinematics analytically &lt;/description&gt;
  &lt;/class&gt;
&lt;/library&gt;
</code></pre></div></div> <ul> <li>Add an <code class="language-plaintext highlighter-rouge">export</code> tag in the <code class="language-plaintext highlighter-rouge">package.xml</code> and it should look like <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>&lt;export&gt;
  &lt;moveit_core plugin="${prefix}/plugin_description.xml"/&gt;
&lt;/export&gt;
</code></pre></div> </div> </li> <li>Copy the missing contents of the <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> into your <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> especially the <code class="language-plaintext highlighter-rouge">install</code> parts</li> <li> <code class="language-plaintext highlighter-rouge">cd</code> to your <code class="language-plaintext highlighter-rouge">catkin_ws</code> and do <code class="language-plaintext highlighter-rouge">catkin_make</code> and <code class="language-plaintext highlighter-rouge">source devel/setup.bash</code>.</li> <li>When it finishes, you should see a <code class="language-plaintext highlighter-rouge">test_arm_moveit_plugin.so</code> (check the <code class="language-plaintext highlighter-rouge">plugin_description.xml</code> library path) generated under <code class="language-plaintext highlighter-rouge">catkin_ws/devel/lib</code>. It’s often in my case, the plugin is not regenerated if an IDE like CLion is used (dont know why!!). So make sure to check the time of generation of the <code class="language-plaintext highlighter-rouge">test_arm_moveit_plugin.so</code> by typing <code class="language-plaintext highlighter-rouge">ll devel/lib | grep test_arm</code>. This will give the time of the latest generation of the plugin. Or as a last resort, remove <code class="language-plaintext highlighter-rouge">build</code> and <code class="language-plaintext highlighter-rouge">devel</code> folders and rerun <code class="language-plaintext highlighter-rouge">catkin_make</code> if the plugin is not generated.</li> <li>Additionally run <code class="language-plaintext highlighter-rouge">rospack plugins --attrib=plugin moveit_core</code> on your console. This should list the full path of <code class="language-plaintext highlighter-rouge">plugin_description.xml</code>.</li> <li>Modify the <code class="language-plaintext highlighter-rouge">robot_moveit_config/config/kinematics.yaml</code> with the following <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>arm:
  kinematics_solver: analytic/kinematicsPlugin
</code></pre></div> </div> <p><strong>Note:</strong> The <code class="language-plaintext highlighter-rouge">robot_moveit_config</code> package is generated using <a href="http://docs.ros.org/en/melodic/api/moveit_tutorials/html/doc/setup_assistant/setup_assistant_tutorial.html?highlight=setup%20assistant" rel="external nofollow noopener" target="_blank">MoveIt Setup Assistant</a>.</p> </li> </ul> <p>Congratulations, Your plugin is ready to be launched when you start your simulation</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/Inverse_kinematics_solutions/">Inverse Kinematics Solutions: Analytic and Optimization Based Approaches</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/2-Developing_ROS_Package/">Part2: Developing a ROS C++ package</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/1-supervised_learning-basic/">Part1: Supervised Learning: Basic linear regression</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/Generating_Symbolic_Expression_for_Forward_Kinematics/">Generating Symbolic Expression for Forward Kinematics</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/2-supervised_learning-non-linear/">Part2: Supervised Learning: Extending to higher dimensions and non-linear regression</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Ashith Shyam Babu, PhD. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a>. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?5d75c11f89cd96294bf5e6dd1ee1bb30"></script> <script defer src="/assets/js/common.js?fcfacfb8c6281f5e68d5a7d348186eb1"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> </body> </html>